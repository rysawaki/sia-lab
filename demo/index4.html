<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIA Model - High Sensitive & Gradual Healing</title>
    <style>
        body {
            background-color: #0d0d0d;
            color: #e0e0e0;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* iOS Safari fix */
            overflow: hidden;
        }
        #header {
            padding: 10px 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 1.1rem; color: #ff5252; }
        .subtitle { font-size: 0.7rem; color: #888; display: block;}
        .status-panel { text-align: right; }
        #action-display {
            font-size: 1.4rem;
            font-weight: bold;
            color: #66bb6a;
        }
        #canvas-container {
            position: relative;
            flex-grow: 1;
            width: 100%;
            background: #000;
            min-height: 0;
        }
        canvas { display: block; width: 100%; height: 100%; }
        .overlay-label {
            position: absolute; left: 10px; font-size: 0.8rem;
            opacity: 0.8; pointer-events: none; text-shadow: 1px 1px 2px black;
        }
        #controls {
            padding: 10px;
            background: #1a1a1a;
            border-top: 1px solid #333;
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 8px;
            height: 80px;
            flex-shrink: 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        button {
            border: none; border-radius: 6px;
            font-family: inherit; font-size: 1rem; font-weight: bold;
            color: white; cursor: pointer;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            line-height: 1.2; -webkit-tap-highlight-color: transparent;
        }
        button small { font-size: 0.7rem; opacity: 0.8; font-weight: normal; }
        button:active { transform: scale(0.96); filter: brightness(0.8); }
        
        .btn-v { background: linear-gradient(135deg, #b71c1c, #e91e63); }
        .btn-s { background: linear-gradient(135deg, #4a148c, #9c27b0); }
        .btn-safe { background: linear-gradient(135deg, #0d47a1, #2196f3); }
    </style>
</head>
<body>

<div id="header">
    <div>
        <h1>SIA Model <span style="font-size:0.8em; border:1px solid red; padding:2px; border-radius:4px;">SENSITIVE</span></h1>
        <span class="subtitle">Pathological Latching & Gradual Healing</span>
    </div>
    <div class="status-panel">
        <div id="action-display">EXPLORE</div>
        <div id="budget-val" style="font-size: 0.8rem; color:#888;">Budget: 100%</div>
    </div>
</div>

<div id="canvas-container">
    <div class="overlay-label" style="top: 10px; color: #ff4081;">■ Stimulus (V + 1.2*S)</div>
    <div class="overlay-label" style="top: 30px; color: #ffffff;">■ Trace (Trauma)</div>
    <div class="overlay-label" style="top: 50px; color: #00e676;">■ Budget (Resource)</div>
    <canvas id="scope"></canvas>
</div>

<div id="controls">
    <button class="btn-v" id="btn-v">V<small>Violation</small></button>
    <button class="btn-s" id="btn-s">S<small>Surprise</small></button>
    <button class="btn-safe" id="btn-safe">SAFE BASE<small>Hold to Heal</small></button>
</div>

<script>
/**
 * SIA Logic: High Sensitivity & Gradual Healing
 */
class RelayBank {
    constructor(N) {
        this.N = N;
        this.c = []; 
        this.q = []; 
        this.alpha = [];
        this.beta = [];

        for(let i=0; i<N; i++) {
            this.c[i] = (i + 0.5) / N;
            this.q[i] = 0;
            
            // ヒステリシス幅の設定
            let width = 0.05; // デフォルトは狭い（すぐ忘れる）
            
            // 深い領域（0.6以上）は「無限のトラウマ」として設定
            if (this.c[i] >= 0.6) {
                width = 1.0; 
                this.beta[i] = -1.0; // 【重要】自然には絶対にOFFにならない
            } else {
                // 浅い～中程度の記憶
                if (this.c[i] >= 0.3) width = 0.25;
                this.beta[i] = Math.max(this.c[i] - width, 0.0);
            }
            
            this.alpha[i] = Math.min(this.c[i] + 0.1, 1.0);
        }
    }

    // s: 刺激, is_safe: 安全基地フラグ
    update(s, is_safe) {
        for(let i=0; i<this.N; i++) {
            
            // --- 治療ロジック（Gradual Healing） ---
            // 安全基地にいる間だけ、無限のトラウマ(beta=-1.0)を、
            // 「普通の記憶(beta = center - 0.15)」として一時的に扱う。
            // これにより、s(刺激)の低下に合わせて、高い閾値から順にOFFになっていく。
            let effective_beta = this.beta[i];
            
            if (is_safe) {
                // 治療モード: 忘却ラインを一時的に引き上げる（回復可能にする）
                effective_beta = Math.max(this.c[i] - 0.15, 0.0);
            }

            // --- 状態更新 ---
            if (s <= effective_beta) {
                // 刺激が「有効な忘却ライン」を下回ったらOFF
                // 安全基地にいるときは effective_beta が高いので、ここでOFFになりやすい
                this.q[i] = 0; 
            } else if (!is_safe && s >= this.alpha[i]) {
                // 安全基地でない時だけ、新規書き込み(ON)
                this.q[i] = 1; 
            }
            // それ以外（effective_beta < s < alpha）は記憶保持
        }
    }

    readout(p=2.0) {
        let num = 0.0;
        let den = 0.0;
        for(let i=0; i<this.N; i++) {
            let w = Math.pow(this.c[i], p);
            num += w * this.q[i];
            den += w;
        }
        return num / (den + 1e-12);
    }
}

// --- Simulation State ---
const N = 64;
const bank = new RelayBank(N);
let input_V = 0.0;
let input_S = 0.0;
let is_safe = false;

// History buffers
const historyLen = 300;
const hist_V = new Array(historyLen).fill(0);
const hist_Trace = new Array(historyLen).fill(0);
const hist_Budget = new Array(historyLen).fill(0);

const RISK = { explore: 0.60, assert: 0.45, repair: 0.20, boundary: 0.10 };

function getAction(budget) {
    if (budget > RISK.explore) return { text: "EXPLORE (Active)", color: "#66bb6a" }; 
    if (budget > RISK.assert)  return { text: "ASSERT (Firm)",    color: "#42a5f5" }; 
    if (budget > RISK.repair)  return { text: "REPAIR (Hesitant)",color: "#ffa726" }; 
    return { text: "BOUNDARY (Closed)",color: "#ff5252" }; 
}

function updatePhysics() {
    // 自然減衰（入力値が下がるスピード）
    input_V *= 0.96; 
    input_S *= 0.92;

    // 【重要】Surprise(S)の係数を1.2に設定（ガラスのハート）
    // S単体でもTraceがMAXになる
    let stimulus = Math.min(input_V + 1.2 * input_S, 1.0);

    // バンク更新
    bank.update(stimulus, is_safe);

    let trace = bank.readout(2.0);
    let budget = Math.max(0.8 - 0.7 * trace, 0.0);

    hist_V.shift(); hist_V.push(stimulus);
    hist_Trace.shift(); hist_Trace.push(trace);
    hist_Budget.shift(); hist_Budget.push(budget);

    const action = getAction(budget);
    document.getElementById('action-display').innerText = action.text;
    document.getElementById('action-display').style.color = action.color;
    document.getElementById('budget-val').innerText = `Budget: ${(budget*100).toFixed(0)}%`;
}

// --- Rendering ---
const canvas = document.getElementById('scope');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
    const container = document.getElementById('canvas-container');
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
}
window.addEventListener('resize', resizeCanvas);
setTimeout(resizeCanvas, 100);

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (is_safe) {
        let grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
        grd.addColorStop(0, "#0d1b2a");
        grd.addColorStop(1, "#1b263b");
        ctx.fillStyle = grd;
        ctx.fillRect(0,0, canvas.width, canvas.height);
        
        ctx.font = "bold 24px Courier New";
        ctx.fillStyle = "rgba(66, 165, 245, 0.2)";
        ctx.textAlign = "center";
        ctx.fillText("SAFE CONTEXT ACTIVE", canvas.width/2, canvas.height/2);
    }

    ctx.strokeStyle = "#333";
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let y=0.2; y<1.0; y+=0.2) {
        let Y = canvas.height * (1-y);
        ctx.moveTo(0, Y); ctx.lineTo(canvas.width, Y);
    }
    ctx.stroke();

    function drawLine(data, color, width) {
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = width;
        let step = canvas.width / (historyLen - 1);
        for (let i = 0; i < historyLen; i++) {
            let x = i * step;
            let y = canvas.height * (1 - data[i] * 0.9 - 0.05);
            if (i===0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.stroke();
    }

    drawLine(hist_V, "#ff4081", 2);      
    drawLine(hist_Budget, "#00e676", 1); 
    drawLine(hist_Trace, is_safe ? "#90caf9" : "#ffffff", 3); 

    requestAnimationFrame(draw);
}

setInterval(updatePhysics, 50);
requestAnimationFrame(draw);

// --- Input Handling ---
const btnV = document.getElementById('btn-v');
const btnS = document.getElementById('btn-s');
const btnSafe = document.getElementById('btn-safe');

const addPress = (el, actionStart, actionEnd) => {
    el.addEventListener('mousedown', actionStart);
    el.addEventListener('mouseup', actionEnd);
    el.addEventListener('mouseleave', actionEnd);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); actionStart(); }, {passive: false});
    el.addEventListener('touchend', (e) => { e.preventDefault(); actionEnd(); }, {passive: false});
};

addPress(btnV, () => { input_V = Math.min(input_V + 0.3, 1.0); }, () => {});
addPress(btnS, () => { input_S = Math.min(input_S + 0.3, 1.0); }, () => {});
addPress(btnSafe, () => { is_safe = true; }, () => { is_safe = false; });

document.addEventListener('keydown', (e) => {
    if (e.repeat) return;
    if (e.key.toLowerCase() === 'v') input_V = Math.min(input_V + 0.3, 1.0);
    if (e.key.toLowerCase() === 's') input_S = Math.min(input_S + 0.3, 1.0);
    if (e.key === ' ') is_safe = true;
});
document.addEventListener('keyup', (e) => { if (e.key === ' ') is_safe = false; });

</script>
</body>
</html>
